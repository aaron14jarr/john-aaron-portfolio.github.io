<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>John Aaron â€” Portfolio (Realtime)</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
:root{--bg:#ffffff;--card:#fff;--accent:#0a6ed1;--muted:#6b7280}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,Arial,Helvetica;background:var(--bg);color:#0b1220;padding:18px}
.hidden{display:none!important}
.container{max-width:980px;margin:18px auto}
.card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,.06);margin-bottom:14px}
.profile-pic{width:150px;height:150px;border-radius:50%;object-fit:cover;display:block;margin:10px auto}
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
.btn.ghost{background:#fff;color:var(--accent);border:1px solid rgba(10,110,209,.12)}
.small{padding:8px 10px;font-size:14px}
.social-item{display:flex;align-items:center;gap:10px;margin:8px 0}
.social-item img{width:28px;height:28px;border-radius:6px}
#removeMenu{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.12);display:none;z-index:2000;width:92%;max-width:380px}
.note{color:var(--muted);font-size:13px;margin-top:8px}
.header-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
.sync-indicator{font-size:13px;color:var(--muted)}
.error{color:#c0392b}
.panel{border:1px dashed #e6eef9;padding:10px;border-radius:8px;margin-top:10px}
@media (max-width:720px){
  .profile-pic{width:120px;height:120px}
  .card{padding:14px}
}
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="passwordScreen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#ffffff;z-index:9999">
  <div style="width:100%;max-width:520px;text-align:center;padding:18px">
    <h2 style="margin:0 0 10px">WELCOME TO JOHN AARON'S PORTFOLIO</h2>
    <input id="viewPassInput" type="password" placeholder="Enter view password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:8px">
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button id="toggleView" class="btn ghost small">Show</button>
      <button id="enterView" class="btn small">Enter</button>
    </div>
    <p id="viewMsg" class="error" style="height:20px;margin-top:8px"></p>
    <div style="margin-top:15px">
      <p id="passwordHint" class="note" style="margin-top:10px; display:none;">(View password is <b id="hintText">Stellotenebris</b>)</p>
    </div>
  </div>
</div>

<main id="mainContent" class="hidden" aria-live="polite">
  <div class="container">

    <div class="card">
      <div class="header-row">
        <div style="flex:1"><img id="profilePic" class="profile-pic" src="" alt="Profile photo"></div>
        <div style="flex:1;text-align:right"><div id="syncStatus" class="sync-indicator">Sync: not connected</div></div>
      </div>

      <div class="controls">
        <button id="uploadPicBtn" class="btn ghost small hidden">Upload Photo</button>
        <button id="editBtn" class="btn small">Edit</button>
        <button id="doneBtn" class="btn small hidden">Done</button>
        <button id="connectBtn" class="btn small ghost">Connect Sync</button>
      </div>

      <h2 style="text-align:center;margin-top:8px">JOHN AARON R. RESURRECCION</h2>
    </div>

    <div class="card">
      <h3>About Me</h3>
      <p id="aboutText">I am John Aaron R. Resurreccion, a passionate and motivated individual who loves exploring technology, creativity, and continuous learning.</p>
    </div>

    <div class="card">
      <h3>Socials</h3>
      <div id="socialList" aria-live="polite"></div>
      <div class="controls">
        <button id="addSocialBtn" class="btn small hidden">Add Social</button>
        <button id="removeSocialBtn" class="btn small ghost hidden">Remove Social</button>
      </div>
    </div>

    <div class="card">
      <h3>Contact</h3>
      <p id="contactText">Globe: 09562460068<br>Smart: 09423379576<br>Email: aaron14.jarr@gmail.com</p>
    </div>

    <!-- Password settings panel shown only in edit mode -->
    <div id="passwordPanel" class="card panel hidden">
      <h4>Password Settings</h4>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="toggleViewerVisibilityBtn" class="btn small ghost">Make viewer password visible</button>
        <button id="changeViewerPasswordBtn" class="btn small">Change viewer password</button>
      </div>
      <p class="note" style="margin-top:8px">Toggle controls whether the viewer hint is visible on the login screen. Changing password updates across devices.</p>
    </div>

  </div>
</main>

<!-- Remove menu -->
<div id="removeMenu" role="dialog" aria-modal="true">
  <h3 style="margin-top:0">Select a social to remove</h3>
  <select id="socialSelect" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb"></select>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button id="confirmRemoveBtn" class="btn small">Remove</button>
    <button id="cancelRemoveBtn" class="btn small ghost">Cancel</button>
  </div>
</div>

<!-- Firestore SDK (modular) - embedded and auto-initialized -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // YOUR FIREBASE CONFIG (embedded)
  const firebaseConfig = {
    apiKey: "AIzaSyCmuovFi9Xjj4ddGgBxH3WpHbVKdNA9GRk",
    authDomain: "aaron-portfolio-611ac.firebaseapp.com",
    projectId: "aaron-portfolio-611ac",
    storageBucket: "aaron-portfolio-611ac.firebasestorage.app",
    messagingSenderId: "343673933744",
    appId: "1:343673933744:web:bafd4688c3267586d0d075"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const profileDocRef = doc(db, "portfolio", "profile");

  // simple SHA-256 hashing for passwords
  async function hash(text){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // DOM nodes
  const passwordScreen = document.getElementById('passwordScreen');
  const viewPassInput = document.getElementById('viewPassInput');
  const toggleView = document.getElementById('toggleView');
  const enterView = document.getElementById('enterView');
  const viewMsg = document.getElementById('viewMsg');
  const passwordHint = document.getElementById('passwordHint');
  const hintText = document.getElementById('hintText');

  const mainContent = document.getElementById('mainContent');
  const uploadPicBtn = document.getElementById('uploadPicBtn');
  const editBtn = document.getElementById('editBtn');
  const doneBtn = document.getElementById('doneBtn');
  const connectBtn = document.getElementById('connectBtn');
  const syncStatus = document.getElementById('syncStatus');

  const aboutText = document.getElementById('aboutText');
  const contactText = document.getElementById('contactText');
  const profilePic = document.getElementById('profilePic');
  const socialList = document.getElementById('socialList');

  const addSocialBtn = document.getElementById('addSocialBtn');
  const removeSocialBtn = document.getElementById('removeSocialBtn');

  const passwordPanel = document.getElementById('passwordPanel');
  const toggleViewerVisibilityBtn = document.getElementById('toggleViewerVisibilityBtn');
  const changeViewerPasswordBtn = document.getElementById('changeViewerPasswordBtn');

  const removeMenu = document.getElementById('removeMenu');
  const socialSelect = document.getElementById('socialSelect');
  const confirmRemoveBtn = document.getElementById('confirmRemoveBtn');
  const cancelRemoveBtn = document.getElementById('cancelRemoveBtn');

  // state
  let VIEW_HASH = '';
  let EDIT_HASH = '';
  const EDIT_PLAIN = 'Johnaaron_rr04';
  (async()=>{ EDIT_HASH = await hash(EDIT_PLAIN); VIEW_HASH = await hash('Stellotenebris'); })();

  let isRealtimeAttached = false;
  let viewerPasswordVisible = false; // from cloud
  let viewerPasswordHash = ''; // from cloud

  // helpers
  function detectIcon(s){
    s=(s||'').toLowerCase();
    if(s.includes('facebook')) return 'https://cdn-icons-png.flaticon.com/512/733/733547.png';
    if(s.includes('instagram')) return 'https://cdn-icons-png.flaticon.com/512/2111/2111463.png';
    if(s.includes('twitter')||s.includes('x.com')) return 'https://cdn-icons-png.flaticon.com/512/733/733579.png';
    if(s.includes('youtube')) return 'https://cdn-icons-png.flaticon.com/512/1384/1384060.png';
    if(s.includes('tiktok')) return 'https://cdn-icons-png.flaticon.com/512/3046/3046121.png';
    if(s.includes('github')) return 'https://cdn-icons-png.flaticon.com/512/733/733553.png';
    return 'https://cdn-icons-png.flaticon.com/512/565/565547.png';
  }
  function normalizeUrl(u){ if(!u) return ''; u=u.trim(); if(u.startsWith('http')) return u; return 'https://'+u; }
  function appendSocialDom(name,url,icon){
    const item = document.createElement('div');
    item.className = 'social-item';
    item.innerHTML = `<img src="${icon}" alt="${name}"><a href="${url}" target="_blank" rel="noopener noreferrer"><span class="sname">${name}</span></a>`;
    socialList.appendChild(item);
  }

  function saveLocal(){
    const socials = Array.from(document.querySelectorAll('.social-item')).map(it=>({
      name: it.querySelector('.sname').innerText,
      url: it.querySelector('a').href,
      icon: it.querySelector('img').src
    }));
    const data = { about: aboutText.innerText, contact: contactText.innerHTML, profilePic: profilePic.src || '', socials, viewerPasswordVisible };
    localStorage.setItem('portfolio_local', JSON.stringify(data));
  }

  function loadLocal(){
    const raw = localStorage.getItem('portfolio_local');
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      if(d.about) aboutText.innerText = d.about;
      if(d.contact) contactText.innerHTML = d.contact;
      if(d.profilePic) profilePic.src = d.profilePic;
      if(typeof d.viewerPasswordVisible !== 'undefined') viewerPasswordVisible = d.viewerPasswordVisible;
      socialList.innerHTML = '';
      (d.socials||[]).forEach(s=>appendSocialDom(s.name, s.url, s.icon));
    }catch(e){ console.warn(e); }
  }

  async function ensureProfileDoc(){
    // ensure the doc exists and has viewerPasswordHash & viewerPasswordVisible defaults
    const snap = await getDoc(profileDocRef);
    if(!snap.exists()){
      // create with defaults
      const defaultHash = await hash('Stellotenebris');
      await setDoc(profileDocRef, { about: aboutText.innerText, contact: contactText.innerHTML, profilePic: profilePic.src || '', socials: [], viewerPasswordHash: defaultHash, viewerPasswordVisible: false });
      viewerPasswordHash = defaultHash;
      viewerPasswordVisible = false;
      hintText.textContent = 'Stellotenebris';
    } else {
      const data = snap.data();
      if(data.viewerPasswordHash) viewerPasswordHash = data.viewerPasswordHash;
      else {
        const defaultHash = await hash('Stellotenebris');
        await setDoc(profileDocRef, { viewerPasswordHash: defaultHash }, { merge: true });
        viewerPasswordHash = defaultHash;
      }
      if(typeof data.viewerPasswordVisible !== 'undefined') viewerPasswordVisible = data.viewerPasswordVisible;
      hintText.textContent = 'Stellotenebris';
    }
  }

  async function loadFromCloudOnce(){
    try{
      const snap = await getDoc(profileDocRef);
      if(snap.exists()){
        const d = snap.data();
        if(d.about) aboutText.innerText = d.about;
        if(d.contact) contactText.innerHTML = d.contact;
        if(d.profilePic) profilePic.src = d.profilePic;
        socialList.innerHTML = '';
        (d.socials||[]).forEach(s=>appendSocialDom(s.name,s.url,s.icon));
        if(typeof d.viewerPasswordVisible !== 'undefined') viewerPasswordVisible = d.viewerPasswordVisible;
        if(d.viewerPasswordHash) viewerPasswordHash = d.viewerPasswordHash;
      }
      syncStatus.textContent = 'Sync: Connected (loaded)';
      syncStatus.style.color = 'green';
    }catch(e){ console.error('load once failed', e); syncStatus.textContent = 'Sync: Error'; }
  }

  function attachRealtime(){
    if(isRealtimeAttached) return;
    unsubscribe = onSnapshot(profileDocRef, (docSnap)=>{
      if(!docSnap.exists()) return;
      const d = docSnap.data();
      if(d.about) aboutText.innerText = d.about;
      if(d.contact) contactText.innerHTML = d.contact;
      if(d.profilePic) profilePic.src = d.profilePic;
      socialList.innerHTML = '';
      (d.socials||[]).forEach(s=>appendSocialDom(s.name,s.url,s.icon));
      if(typeof d.viewerPasswordVisible !== 'undefined') viewerPasswordVisible = d.viewerPasswordVisible;
      if(d.viewerPasswordHash) viewerPasswordHash = d.viewerPasswordHash;
      hintText.textContent = viewerPasswordVisible ? 'Stellotenebris' : hintText.textContent;
      saveLocal();
      syncStatus.textContent = 'Sync: Connected (realtime)';
      syncStatus.style.color = 'green';
    }, (err)=>{ console.error('realtime err', err); syncStatus.textContent = 'Sync: Error'; });
    isRealtimeAttached = true;
  }

  function setSync(text,color=null){ syncStatus.textContent = 'Sync: '+text; syncStatus.style.color = color || ''; }

  // initial load of local fallback and ensure doc
  loadLocal();
  (async()=>{
    await ensureProfileDoc();
  })();

  // Password UI
  toggleView.addEventListener('click', ()=> {
    viewPassInput.type = viewPassInput.type === 'password' ? 'text' : 'password';
    toggleView.textContent = viewPassInput.type === 'password' ? 'Show' : 'Hide';
  });

  enterView.addEventListener('click', async ()=>{
    const input = viewPassInput.value || '';
    const hv = await hash(input);
    // if cloud hash available, compare; otherwise fall back to default VIEW_HASH
    const compareHash = viewerPasswordHash || VIEW_HASH;
    if(hv === compareHash){
      passwordScreen.style.display = 'none';
      mainContent.classList.remove('hidden');
      loadLocal();
      try{ await loadFromCloudOnce(); attachRealtime(); }catch(e){ console.warn('cloud not available', e); }
      // show/hide hint based on viewerPasswordVisible
      passwordHint.style.display = viewerPasswordVisible ? 'block' : 'none';
    } else {
      viewMsg.textContent = 'Incorrect password';
      setTimeout(()=> viewMsg.textContent = '', 1800);
    }
  });

  // Edit flow (requires edit password)
  editBtn.addEventListener('click', async ()=>{
    const pwd = prompt('Enter edit password:');
    if(!pwd) return;
    if(await hash(pwd) !== EDIT_HASH){ alert('Wrong edit password'); return; }
    // enable editing UI
    uploadPicBtn.classList.remove('hidden');
    addSocialBtn.classList.remove('hidden');
    removeSocialBtn.classList.remove('hidden');
    doneBtn.classList.remove('hidden');
    passwordPanel.classList.remove('hidden');
    editBtn.classList.add('hidden');
    aboutText.contentEditable = true;
    contactText.contentEditable = true;
  });

  // toggle viewer visibility button (editor only)
  toggleViewerVisibilityBtn.addEventListener('click', async ()=>{
    // flip state
    viewerPasswordVisible = !viewerPasswordVisible;
    try{
      await setDoc(profileDocRef, { viewerPasswordVisible }, { merge: true });
      // update UI text
      toggleViewerVisibilityBtn.textContent = viewerPasswordVisible ? 'Hide viewer password' : 'Make viewer password visible';
      // update hint shown on login screen
      passwordHint.style.display = viewerPasswordVisible ? 'block' : 'none';
      saveLocal();
    }catch(e){ alert('Failed to update visibility: '+(e.message||e)); }
  });

  // change viewer password button
  changeViewerPasswordBtn.addEventListener('click', async ()=>{
    const newPw = prompt('Enter new viewer password:');
    if(!newPw) return;
    const confirmPw = prompt('Confirm new viewer password:');
    if(newPw !== confirmPw){ alert('Passwords did not match'); return; }
    const newHash = await hash(newPw);
    try{
      await setDoc(profileDocRef, { viewerPasswordHash: newHash }, { merge: true });
      viewerPasswordHash = newHash;
      // update hint text (we store plain hint as 'Stellotenebris' default; to avoid storing plaintext we show masked hint)
      hintText.textContent = viewerPasswordVisible ? newPw : hintText.textContent;
      alert('Viewer password updated.');
      saveLocal();
    }catch(e){ alert('Failed to change password: '+(e.message||e)); }
  });

  doneBtn.addEventListener('click', async ()=>{
    uploadPicBtn.classList.add('hidden');
    addSocialBtn.classList.add('hidden');
    removeSocialBtn.classList.add('hidden');
    doneBtn.classList.add('hidden');
    passwordPanel.classList.add('hidden');
    editBtn.classList.remove('hidden');
    aboutText.contentEditable = false;
    contactText.contentEditable = false;
    // save to cloud
    try{
      const socials = Array.from(document.querySelectorAll('.social-item')).map(it=>({ name: it.querySelector('.sname').innerText, url: it.querySelector('a').href, icon: it.querySelector('img').src }));
      const payload = { about: aboutText.innerText, contact: contactText.innerHTML, profilePic: profilePic.src || '', socials, viewerPasswordVisible };
      await setDoc(profileDocRef, payload, { merge: true });
      setSync('Connected (saved)', 'green');
      saveLocal();
    }catch(e){ console.error('save failed', e); alert('Save failed: '+(e.message||e)); }
  });

  // upload picture
  uploadPicBtn.addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = e=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ev => { profilePic.src = ev.target.result; saveLocal(); try{ setDoc(profileDocRef, { profilePic: profilePic.src }, { merge: true }); }catch(e){} };
      reader.readAsDataURL(f);
    };
    inp.click();
  });

  // add social
  addSocialBtn.addEventListener('click', ()=>{
    const name = prompt('Social name (e.g. Facebook)'); if(!name) return;
    let url = prompt('Link (include https:// or domain)'); if(!url) return;
    url = normalizeUrl(url);
    appendSocialDom(name, url, detectIcon(name));
  });

  // remove social
  removeSocialBtn.addEventListener('click', ()=>{
    socialSelect.innerHTML = '';
    document.querySelectorAll('.social-item .sname').forEach(s=>{
      const o = document.createElement('option'); o.value = s.innerText; o.textContent = s.innerText; socialSelect.appendChild(o);
    });
    removeMenu.style.display = 'block';
  });
  cancelRemoveBtn.addEventListener('click', ()=> removeMenu.style.display = 'none');
  confirmRemoveBtn.addEventListener('click', ()=>{
    const val = socialSelect.value;
    document.querySelectorAll('.social-item').forEach(it=>{
      if(it.querySelector('.sname').innerText === val) it.remove();
    });
    removeMenu.style.display = 'none';
    saveLocal();
    try{ setDoc(profileDocRef, { socials: Array.from(document.querySelectorAll('.social-item')).map(it=>({ name: it.querySelector('.sname').innerText, url: it.querySelector('a').href, icon: it.querySelector('img').src })) }, { merge: true }); }catch(e){}
  });

  // connect button manual
  connectBtn.addEventListener('click', async ()=>{
    try{ await loadFromCloudOnce(); attachRealtime(); alert('Connected to Firestore and listening.'); }catch(e){ alert('Connect failed: '+(e.message||e)); }
  });

  // auto save fallback
  window.addEventListener('beforeunload', ()=> saveLocal());

  // initial sync state
  setSync('Idle');
</script>

</body>
</html>
